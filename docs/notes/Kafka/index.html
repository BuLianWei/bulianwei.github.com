<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Kafka | Abiu的博客</title>
    <meta property="og:title" content="Kafka - Abiu的博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2020-01-13T15:22:21&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2020-01-13T15:22:21&#43;08:00'>
        
    <meta name="Keywords" content="">
    <meta name="description" content="Kafka">
        
    <meta name="author" content="Abiu">
    <meta property="og:url" content="https://github.com/BuLianWei/bulianwei.github.io/notes/Kafka/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href='/BuLianWei/bulianwei.github.io/css/normalize.css'>
    <link rel="stylesheet" href='/BuLianWei/bulianwei.github.io/css/style.css'>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-4031353640611810",
        enable_page_level_ads: true
    });
    </script>
    


    
    
        <link rel="stylesheet" href='/BuLianWei/bulianwei.github.io/css/douban.css'>
    
        <link rel="stylesheet" href='/BuLianWei/bulianwei.github.io/css/other.css'>
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://github.com/BuLianWei/bulianwei.github.io">
                        Abiu的博客
                    </a>
                
                
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="" href="https://github.com/BuLianWei/bulianwei.github.io">首页</a>
                    
                    <a  href="https://github.com/BuLianWei/bulianwei.github.io/notes/" title="笔记">笔记</a>
                    
                    <a  href="https://github.com/BuLianWei/bulianwei.github.io/post/" title="归档">归档</a>
                    
                    <a  href="https://github.com/BuLianWei/bulianwei.github.io/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">Kafka</h1>
        </header>
        <date class="post-meta meta-date">
            2020年1月13日
        </date>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <h1 id="kafka">Kafka</h1>
<p>一个分区内的数据才能保证幂等性和有序性</p>
<h2 id="架构">架构</h2>
<p><img src="img/kafka%E6%9E%B6%E6%9E%84.png" alt="架构图" title="dd"></p>
<p><img src="img/kafka.png" alt="kafka"></p>
<h2 id="名次解释">名次解释</h2>
<ul>
<li>Broker：Kafka服务器</li>
<li>Producer：生产者，生产消息</li>
<li>Consumer：消费者，消费数据</li>
<li>Consumer Group：消费者组，某一个分区只能被同一个消费者组内的一个消费者消费</li>
<li>Topic：消息主题。逻辑概念</li>
<li>Partition：消息分区。消息物理存储上概念</li>
<li>Offset：偏移量</li>
<li>Replica：副本，同一个分区（Partition）内的副本分Leader和Follower</li>
<li>Leader：主副本。对外提供服务</li>
<li>Follower：从副本。做数据同步工作</li>
<li>acks：acknowledgments，消息接收后的确认值</li>
<li>AR（Assigned Replicas）：分区中所有副本</li>
<li>ISR（In-Sync Replicas）：所有与Leader 部分保持一定程度的副本（包含Leader副本在内）组成ISR</li>
<li>OSR（Out-Sync Replicas）：与Leader副本同步滞后过多的副本</li>
<li>HW（High Watermark）：高水位，消费者能见到的最大的offset，只能消费hw之前的数据。ISR队列中最小的LEO。保证消费者消费数据的一致性</li>
<li>LSO（log Start Offset）：该副本第一个offset。</li>
<li>LEO（Log End Offset）：该副本数据最大偏移量的下一个值（即该副本最新offset+1），里面没要消息。即日志末端位移，记录了该副本底层日志中下一条消息的位移值。注意是下一条消息，也就是说如果LEO=10，那么表示该副本保存了10条消息，位移值范围是[0,9]。日志末端位移，代表日志文件中下一条待写入消息的offset，这个offset上实际是没有消息的。不管是leader副本还是follower副本，都有这个值。当leader副本收到生产者的一条消息，LEO通常会自增1，而follower副本需要从leader副本fetch到数据后，才会增加它的LEO，最后leader副本会比较自己的LEO以及满足条件的follower副本上的LEO，选取两者中较小值作为新的HW，来更新自己的HW值。</li>
</ul>
<blockquote>
<p>1 Topic = n Partition
1 Partition = n Replica
1 Replica = n Segment
1 Segment = 2 File （ .log ，.index)</p>
</blockquote>
<h2 id="producer生产者">Producer（生产者）</h2>
<p>拦截器-&gt;序列化器-&gt;分区器</p>
<p>kafka无法保证整个topic多个分区有序，但是由于每个分区（partition）内，每条消息都有一个offset，故可以保证分区内有序。</p>
<h3 id="写流程">写流程</h3>
<p><img src="img/kafka%E5%86%99.png" alt="kafka写"></p>
<ul>
<li>producer根据分区原则确定自己需要发送到的Partition后，先从broker-list获取该Partition的leader</li>
<li>producer将消息发送给leader</li>
<li>leader将该消息写入本地log</li>
<li>follower从leader pull消息</li>
<li>写入本地log后向leader发送ack</li>
<li>leader收到所有follower的ack后向producer发送ack</li>
</ul>
<h3 id="命令">命令</h3>
<h4 id="使用脚本">使用脚本</h4>
<p>kafka-console-producer.sh</p>
<h4 id="常用参数">常用参数</h4>
<ul>
<li>&ndash;broker-list	//kafka集群地址</li>
<li>&ndash;topic	//生产主题</li>
</ul>
<h4 id="举例">举例</h4>
<p>kafka-console-producer.sh	&ndash;broker-list	localhost:9092	&ndash;topic	test</p>
<h3 id="分区策略">分区策略</h3>
<ol>
<li>
<p>指定分区（Partition）：直接按照分区号</p>
</li>
<li>
<p>没有分区（Partition）但是有Key：（默认）根据Key的Hash值获取分区号</p>
</li>
<li>
<p>即没有分区（Partition）也没有Key：第一次先随机获取一个分区号，然后在这个分区号的基础上轮询所有分区号。</p>
<blockquote>
<p>如果有3个分区，0、1、2当随机获取的分区号为1时，然后1、2、0、1、2、0、1 &hellip; 这样轮询下去</p>
</blockquote>
</li>
</ol>
<h3 id="发送返回值">发送返回值</h3>
<p>ACKS值：</p>
<ul>
<li>0：Producer不等待Leader所在的Broker的acks，这一操作保证了最低延迟，Leader所在的Broker一接到消息不等消息保存就会先将ack的值返回给Producer。此值下当Leader所在的Broker宕机时会造成数据丢失</li>
<li>1：Producer等待Leader所在的Broker的acks，当Leader所在Broker接收到消息保存完消息后才会将ack值返回给Producer。在Leader的消息落盘后还没等Follower同步数据其所在Broker宕机后，就会导致数据丢失。（默认）</li>
<li>-1（all）：Producer等待Leader所在的Broker的acks，当Leader和ISR中的Follower全部将消息落盘之后所在的Broker才会将ack的值返回给Producer。但是如果Follower将消息同步完以后，Leader所在的Broker还没将ack的值返回给Producer之前，Leader所在的Broker发生故障，会造成数据重复</li>
</ul>
<h3 id="幂等性">幂等性</h3>
<p>设置：enable.idempotence=true
解决单次会话单个分区数据重复问题
开启幂等性的Producer在初始化的时候会被分配一个PID，发往同一Partition的消息会附带SequenceNumber，而Broker会对&lt;PID，Partition，SequenceNumber&gt;做缓存，当具有相同主键的消息提及时，Broker只会持久化一条。</p>
<h2 id="consumer消费者">Consumer（消费者）</h2>
<p>当前消费者需要提交的消费位移是offset+1</p>
<h3 id="命令-1">命令</h3>
<h4 id="使用脚本-1">使用脚本</h4>
<p>kafka-console-consumer.sh</p>
<h4 id="常用参数-1">常用参数</h4>
<ul>
<li>&ndash;bootstrap-server	//目标服务器地址</li>
<li>&ndash;topic	//消费主题</li>
</ul>
<h4 id="举例-1">举例</h4>
<p>kafka-console-consumer.sh	&ndash;bootstrap-server	localhost:9092	&ndash;topic	test</p>
<blockquote>
<p>kafka-console-consumer.sh &ndash;zookeeper zk1:2181,zk2:2181,zk:2181 &ndash;topic	test     //kafka 2.2 及以上后不建议使用 &ndash;zookeeper</p>
</blockquote>
<h3 id="分配策略">分配策略</h3>
<ul>
<li>RoundRobin	将订阅的所有主题看作一个整体。（按组分配）</li>
<li>Range	将订阅的单个主题看作整体。（按主题分配）</li>
</ul>
<h3 id="消息积压">消息积压</h3>
<p>数据积压主要可以从两个角度去分析：</p>
<ul>
<li>
<p>如果是 Kafka 消费能力不足，则可以考虑增加 Topic 的分区数，并且同时提升消费组的消费者数量，消费者数=分区数。（两者缺一不可）</p>
</li>
<li>
<p>如果是下游的数据处理不及时：提高每批次拉取的数量。如果是因为批次拉取数据过少（拉取 数据/处理时间&lt;生产速度），也会使处理的数据小于生产的数据，造成数据积压。</p>
</li>
</ul>
<h3 id="保证精准一次消费">保证精准一次消费</h3>
<p>在实际情况下，我们对于某些比较重要的消息，需要保证exactly once语义，也就是保证每条消息被发送且仅被发送一次，不能重复。在0.11版本之后，Kafka引入了幂等性机制（idempotent），配合acks = -1时的at least once语义，实现了producer到broker的exactly once语义。
idempotent + at least once = exactly once
使用时，只需将enable.idempotence属性设置为true，kafka自动将acks属性设为-1。</p>
<h2 id="topic主题">Topic（主题）</h2>
<h3 id="命令-2">命令</h3>
<h4 id="使用脚本-2">使用脚本</h4>
<p>kafka-configs.sh	//0.9中已经废弃kafka-topics.sh脚本，改用kafka-configs.sh来配置主题</p>
<h4 id="常用参数-2">常用参数</h4>
<ul>
<li>&ndash;zookeeper	//zookeeper地址，多个用逗号链接</li>
<li>&ndash;create	//创建命令</li>
<li>&ndash;list	//列出所有主题</li>
<li>&ndash;alter	//修改主题</li>
<li>&ndash;delete	//删除主题</li>
<li>&ndash;topic	//主题</li>
<li>&ndash;partitions	//主题分区数，分区数要小于等于broker数</li>
<li>&ndash;replication-fator	//主题副本数</li>
</ul>
<h4 id="举例-2">举例</h4>
<ul>
<li>创建主题：kafka-configs.sh	&ndash;zookeeper	localhost:9092	&ndash;create	&ndash;topic	test	&ndash;partition	2	&ndash;replication-fator	3</li>
<li>列出所有主题：kafka-configs.sh	&ndash;zookeeper	localhost:9092	&ndash;list</li>
<li>列出主题详情：kafka-configs.sh	&ndash;zookeeper	localhost:9092	&ndash;describe	&ndash;topic test</li>
<li>修改主题：kafka-configs.sh	&ndash;zookeeper	localhost:9092	&ndash;alter	&ndash;topic test</li>
<li>删除主题：kafka-configs.sh	&ndash;zookeeper	localhost:9092	&ndash;delete	&ndash;topic test</li>
</ul>
<h2 id="kafka高读写">Kafka高读写</h2>
<ul>
<li>
<p>顺序读写</p>
</li>
<li>
<p>Page Cache
利用操作系统自身的内存</p>
</li>
<li>
<p>零复制
传统应用程序，首先通过系统调用将文件数据读入到内核态Buffer（DMA拷贝），然后应用程序将内存态Buffer数据读入到用户态Buffer（CPU拷贝），接着用户程序通过Socket发送数据时将用户态Buffer数据拷贝到内核态Buffer（CPU拷贝），最后通过DMA拷贝将数据拷贝到NIC Buffer。
kafka，数据通过DMA拷贝到内核态Buffer后，直接通过DMA拷贝到NIC Buffer，无需CPU拷贝
<img src="./img/%E6%99%AE%E9%80%9A%E6%8B%B7%E8%B4%9D.png" alt="普通拷贝">
<img src="./img/%E9%9B%B6%E6%8B%B7%E8%B4%9D.png" alt="零拷贝 "></p>
</li>
<li>
<p>文件分段</p>
</li>
<li>
<p>批量发送</p>
</li>
<li>
<p>数据压缩</p>
</li>
</ul>
<p>​</p>

        </div>

        


        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/BuLianWei/bulianwei.github.io/notes/Redis/">Redis</a></li>
        
        <li><a href="/BuLianWei/bulianwei.github.io/about/">个人简历</a></li>
        
        <li><a href="/BuLianWei/bulianwei.github.io/notes/hello-world/">Hello World</a></li>
        
        <li><a href="/BuLianWei/bulianwei.github.io/notes/Bigdata/">BigData</a></li>
        
        <li><a href="/BuLianWei/bulianwei.github.io/notes/Docker/">Docker</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            没有标签
            
        </div>
    </article>
    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "yourdiscussshortname" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "your github repo"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://github.com/BuLianWei/bulianwei.github.io/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://github.com/BuLianWei/bulianwei.github.io">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://github.com/BuLianWei/bulianwei.github.io/post/Kubernetes%E5%AE%89%E8%A3%85/" title="Kubernetes安装">Kubernetes安装</a>
    </li>
    
    <li>
        <a href="https://github.com/BuLianWei/bulianwei.github.io/post/Docekr%E5%AE%89%E8%A3%85/" title="Docekr安装">Docekr安装</a>
    </li>
    
    <li>
        <a href="https://github.com/BuLianWei/bulianwei.github.io/post/Trouble/" title="Trouble">Trouble</a>
    </li>
    
    <li>
        <a href="https://github.com/BuLianWei/bulianwei.github.io/post/Flink/" title="Flink">Flink</a>
    </li>
    
</ul>
    </section>

    
<section class="widget">
    <h3 class="widget-title" style="color:red">福利派送</h3>
    <ul class="widget-list">
        
        <li>
            <a href="" title="这里是广告位" target="_blank" style="color:red">
                
                    这里是广告位
                
            </a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="" title=""></a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://github.com/BuLianWei/bulianwei.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div class="container">
        &copy; 2020 <a href="https://github.com/BuLianWei/bulianwei.github.io">Abiu的博客 By Abiu</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="https://www.flysnow.org/" target="_blank">Theme</a> based on <a href="https://github.com/flysnow-org/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>


<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/BuLianWei/bulianwei.github.io/js/totop.js?v=0.0.0' async=""></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




    <script src='/BuLianWei/bulianwei.github.io/js/douban.js'></script>

</body>

</html>